document.addEventListener("DOMContentLoaded",function(){function m(o){const e=o.target.files[0],t=document.getElementById("image-preview"),a=document.getElementById("error-message");if(e&&e.type.startsWith("image/")){const n=new Image;n.onload=function(){if(n.width===334&&n.height===200){const s=new FileReader;s.onload=function(l){const u=l.target.result;t.src=u,t.style.display="block",a.style.display="none",o.target.setAttribute("data-base64-image",u)},s.readAsDataURL(e)}else d(),a.style.display="block"},n.src=URL.createObjectURL(e)}else d(),a.style.display="none";function d(){t.style.display="none",o.target.value="",o.target.removeAttribute("data-base64-image")}}document.getElementById("cover-upload").addEventListener("change",m);const g=document.querySelector("#createContent"),r=document.getElementById("nextStep"),p=document.getElementById("e-testing"),i=document.getElementById("buttonText");document.getElementById("loadingText"),document.getElementById("arrowIcon");const f=i.textContent,y=()=>{const o=document.getElementById("cover-upload").files[0],e=document.querySelector('input[name="plan"]').files[0],t=document.querySelector('input[name="file"]').files[0];if(!o||!e||!t)throw new Error("กรุณาอัพโหลดไฟล์ให้ครบถ้วน");if(o.size>10*1024*1024)throw new Error("ไฟล์รูปภาพต้องมีขนาดไม่เกิน 10MB");if(e.size>(e.type==="video/mp4"?100:10)*1024*1024)throw new Error("ไฟล์แผนการสอนมีขนาดเกินที่กำหนด");if(t.size>(t.type==="video/mp4"?100:10)*1024*1024)throw new Error("ไฟล์เนื้อหามีขนาดเกินที่กำหนด")},w=o=>{const e=document.createElement("div");e.className="fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50",e.textContent=o,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)},h=o=>{const e=document.getElementById("progressBar"),t=document.getElementById("progressText");document.getElementById("uploadProgress").classList.remove("hidden"),e.style.width=`${o}%`,t.textContent=`กำลังอัพโหลด: ${o}%`};function c(o){o?(r.classList.add("button-loading"),i.textContent="กำลังดำเนินการ",r.disabled=!0):(r.classList.remove("button-loading"),i.textContent=f,r.disabled=!1)}r.addEventListener("click",async function(o){o.preventDefault();try{c(!0);const e=new FormData(g);if(!e.get("title")||!e.get("level")||!e.get("category"))throw new Error("กรุณากรอกข้อมูลให้ครบถ้วน");y(),document.querySelectorAll('input[type="file"]').forEach(n=>{const s=n.name;if(n.files.length>0){const l=n.files[0];e.append(s,l)}});const t=new XMLHttpRequest;t.upload.addEventListener("progress",n=>{if(n.lengthComputable){const s=Math.round(n.loaded/n.total*100);h(s)}});const d=await new Promise((n,s)=>{t.onload=function(){if(t.status>=200&&t.status<300){const l=JSON.parse(t.responseText);n(l)}else s(new Error("Upload failed"))},t.onerror=()=>s(new Error("Network error")),t.open("POST","/content/store",!0),t.setRequestHeader("X-CSRF-TOKEN",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),t.send(e)});document.getElementById("uploadProgress").classList.add("hidden"),p.checked&&d.data.questionData?window.location.href="/quiz/builder?content_id="+d.data.id:window.location.href="/"}catch(e){document.getElementById("uploadProgress").classList.add("hidden"),w(e.message),c(!1)}})});
